{% extends 'base.html' %}

{% block title %}{{ investigation.title }} - RoroEnquête{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900">
    <!-- Investigation Header -->
    <div class="bg-slate-800 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-white">{{ investigation.title }}</h1>
                    <p class="text-slate-400 flex items-center gap-2">
                        <span>Code&nbsp;:</span>
                        <button id="investigationCodeBtn"
                                type="button"
                                data-code="{{ investigation.code }}"
                                data-original-label="{{ investigation.code }}"
                                data-copied-label="Copié !"
                                class="inline-flex items-center gap-2 font-mono text-blue-400 hover:text-blue-300 bg-slate-800/40 border border-blue-500/40 rounded px-2 py-1 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-900">
                            <span data-code-display>{{ investigation.code }}</span>
                            <i class="fas fa-copy text-xs" aria-hidden="true"></i>
                            <span class="sr-only">Copier le code de l'enquête</span>
                        </button>
                    </p>
                    <!-- Presence bubbles -->
                    <div id="presenceBubbles" class="mt-2 flex items-center space-x-2"></div>
                    {% if investigation.description %}
                    <p class="text-slate-300 mt-2">{{ investigation.description }}</p>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-3">
                    <a href="{% url 'dashboard' %}" 
                       class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </a>
                    {% if user_role == 'owner' %}
                    <button type="button"
                            id="investigationSettingsBtn"
                            onclick="openInvestigationSettingsModal()"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- View Toggle -->
            <div class="flex space-x-2">
                <button id="timelineBtn" onclick="switchView('timeline')" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg transition-all">
                    <i class="fas fa-clock mr-2"></i>Timeline
                </button>
                <button id="networkBtn" onclick="switchView('network')" 
                        class="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 transition-all">
                    <i class="fas fa-project-diagram mr-2"></i>Graphe de liens
                </button>
                <button id="cardsBtn" onclick="switchView('cards')" 
                        class="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 transition-all">
                    <i class="fas fa-th-large mr-2"></i>Fiches
                </button>
            </div>
        </div>
    </div>

    <!-- Add Entity Buttons -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-wrap gap-3 mb-6">
            <button id="addPrimaryBtn" onclick="openAddTypeModal()"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                <i class="fas fa-plus mr-2"></i>Ajouter
            </button>
        </div>

        <!-- Add type selection modal: choose which kind of entity/link to add -->
        <div id="addTypeModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">Ajouter</h3>
                        <button onclick="closeAddTypeModal()" class="text-slate-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="(function(){ openAddModal('person'); closeAddTypeModal(); })()"
                                class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg text-left">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-user"></i>
                                <div>
                                    <div class="font-semibold">Personne</div>
                                    <div class="text-slate-200 text-sm">Ajouter une personne</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="(function(){ openAddModal('location'); closeAddTypeModal(); })()"
                                class="w-full px-4 py-3 bg-amber-600 hover:bg-amber-700 rounded-lg text-left">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-map-marker-alt"></i>
                                <div>
                                    <div class="font-semibold">Lieu</div>
                                    <div class="text-slate-200 text-sm">Ajouter un lieu de l'enquête</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="(function(){ openAddModal('evidence'); closeAddTypeModal(); })()"
                                class="w-full px-4 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-left">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file-alt"></i>
                                <div>
                                    <div class="font-semibold">Preuve</div>
                                    <div class="text-slate-200 text-sm">Ajouter une preuve</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="(function(){ openAddModal('event'); closeAddTypeModal(); })()"
                                class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-left">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-calendar"></i>
                                <div>
                                    <div class="font-semibold">Événement</div>
                                    <div class="text-slate-200 text-sm">Ajouter un événement</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="(function(){ openLinkModal(); closeAddTypeModal(); })()"
                                class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-left">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-link"></i>
                                <div>
                                    <div class="font-semibold">Lien</div>
                                    <div class="text-slate-200 text-sm">Créer un lien entre entités</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if user_role == 'owner' %}
        <div id="investigationSettingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-slate-800 rounded-2xl w-full max-w-2xl p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-white">Paramètres de l'enquête</h3>
                            <p class="text-sm text-slate-400">Gérez les accès et supprimez l'enquête si nécessaire.</p>
                        </div>
                        <button type="button" onclick="closeInvestigationSettingsModal()" class="text-slate-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
                            <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wide">Code d'accès</h4>
                            <p class="mt-2 text-slate-300">Code actuel :
                                <span id="investigationSettingsCode" class="ml-2 font-mono text-lg text-blue-300">{{ investigation.code }}</span>
                            </p>
                            <p class="mt-1 text-xs text-slate-400">Retirer un membre régénère automatiquement le code.</p>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wide">Membres</h4>
                                <span class="text-xs text-slate-500">Seuls les rôles non propriétaires peuvent être retirés.</span>
                            </div>
                            <div id="investigationMembersList" class="space-y-3">
                                <div class="text-sm text-slate-400">Chargement des membres...</div>
                            </div>
                        </div>

                        <div class="border-t border-slate-700 pt-4">
                            <h4 class="text-sm font-semibold text-red-400 uppercase tracking-wide mb-3">Zone dangereuse</h4>
                            <p class="text-sm text-slate-300 mb-3">Supprimer l'enquête retirera définitivement toutes les données et l'accès pour tous les membres.</p>
                            <button type="button" id="deleteInvestigationBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white transition-colors">
                                <i class="fas fa-trash mr-2"></i>Supprimer l'enquête
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Filter & sort panel -->
        <div class="relative mb-6">
            <button id="filterButton" onclick="toggleFilterDropdown()" class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 flex items-center gap-2">
                <i class="fas fa-filter"></i>
                <span>Filtres &amp; Tri</span>
            </button>

            <div id="filterDropdown" class="hidden absolute mt-2 left-0 w-[28rem] max-w-[90vw] bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-50 p-5">
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-1">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wide">Types d'éléments</h4>
                            <button type="button" id="filterTypeAllBtn" class="text-xs text-blue-400 hover:text-blue-300" onclick="app.resetTypeFilters()">Tout</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2" id="filterTypeButtons">
                            <button type="button" class="filter-type-btn px-3 py-2 text-sm bg-slate-800/80 border border-slate-700 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors flex items-center justify-center gap-2" data-filter-type="person" onclick="app.toggleTypeFilter('person')">
                                <i class="fas fa-user"></i><span>Personnes</span>
                            </button>
                            <button type="button" class="filter-type-btn px-3 py-2 text-sm bg-slate-800/80 border border-slate-700 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors flex items-center justify-center gap-2" data-filter-type="location" onclick="app.toggleTypeFilter('location')">
                                <i class="fas fa-map-marker-alt"></i><span>Lieux</span>
                            </button>
                            <button type="button" class="filter-type-btn px-3 py-2 text-sm bg-slate-800/80 border border-slate-700 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors flex items-center justify-center gap-2" data-filter-type="evidence" onclick="app.toggleTypeFilter('evidence')">
                                <i class="fas fa-file-alt"></i><span>Preuves</span>
                            </button>
                            <button type="button" class="filter-type-btn px-3 py-2 text-sm bg-slate-800/80 border border-slate-700 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors flex items-center justify-center gap-2" data-filter-type="event" onclick="app.toggleTypeFilter('event')">
                                <i class="fas fa-calendar"></i><span>Événements</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wide mb-2">Attributs rapides</h4>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 text-sm text-slate-200 bg-slate-900/60 px-3 py-2 rounded-lg border border-slate-700">
                                <input type="checkbox" id="filterHasDescription" class="h-4 w-4 rounded border-slate-600 text-blue-500 focus:ring-blue-400" onchange="app.toggleAttributeFilter('has_description', this.checked)">
                                <span>Avec description</span>
                            </label>
                            <label class="flex items-center gap-3 text-sm text-slate-200 bg-slate-900/60 px-3 py-2 rounded-lg border border-slate-700">
                                <input type="checkbox" id="filterHasLinks" class="h-4 w-4 rounded border-slate-600 text-blue-500 focus:ring-blue-400" onchange="app.toggleAttributeFilter('has_links', this.checked)">
                                <span>Avec liens</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wide mb-2">Focus sur des entités</h4>
                        <p class="text-xs text-slate-500 mb-3">Sélectionnez une ou plusieurs entités pour afficher leurs fiches et tout ce qui leur est relié.</p>
                        <div class="space-y-3">
                            <div>
                                <h5 class="text-xs uppercase tracking-wide text-slate-400 mb-2">Personnes</h5>
                                <div id="personsList" class="flex flex-col gap-1 text-slate-300 text-sm"></div>
                            </div>
                            <div>
                                <h5 class="text-xs uppercase tracking-wide text-slate-400 mb-2">Lieux</h5>
                                <div id="placesList" class="flex flex-col gap-1 text-slate-300 text-sm"></div>
                            </div>
                            <div>
                                <h5 class="text-xs uppercase tracking-wide text-slate-400 mb-2">Événements</h5>
                                <div id="eventsList" class="flex flex-col gap-1 text-slate-300 text-sm"></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-semibold text-slate-300 uppercase tracking-wide mb-2">Trier par</h4>
                        <select id="sortSelect" class="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-lg text-sm text-slate-200 focus:border-blue-500 focus:outline-none" onchange="app.onSortChange(event)">
                            <option value="updated_desc">Dernières mises à jour</option>
                            <option value="updated_asc">Premières mises à jour</option>
                            <option value="created_desc">Création (récent → ancien)</option>
                            <option value="created_asc">Création (ancien → récent)</option>
                            <option value="title_asc">Titre A → Z</option>
                            <option value="title_desc">Titre Z → A</option>
                            <option value="type_asc">Type</option>
                            <option value="links_desc">Nombre de liens</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-700">
                    <button type="button" onclick="clearFilters();" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm text-slate-200">Réinitialiser</button>
                    <button type="button" onclick="applyFilters(); toggleFilterDropdown();" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm text-white">Appliquer</button>
                </div>
            </div>

            <div class="mt-3 space-y-3">
                <input type="text" id="searchInput" placeholder="Rechercher..." oninput="app.onSearchInput(event)"
                       class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none text-slate-200 placeholder-slate-500">
                <div id="activeFilterChips" class="hidden flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Timeline View -->
    <div id="timelineView" class="max-w-7xl mx-auto px-6 pb-12">
        <div id="timelineContainer" class="timeline-calendar overflow-x-auto">
            <div id="timelineCalendarInner" class="timeline-calendar-inner">
                <div id="timelineAxis" class="timeline-axis"></div>
                <div id="timelineEvents" class="timeline-events"></div>
            </div>
        </div>
        <div id="timelineEmptyState" class="timeline-empty hidden">
            <div class="text-center py-12">
                <i class="fas fa-calendar text-4xl text-slate-600 mb-4"></i>
                <p class="text-slate-400">Aucun événement à afficher</p>
            </div>
        </div>
    </div>

    <!-- Network View -->
    <div id="networkView" class="hidden max-w-7xl mx-auto px-6 pb-12">
        <div class="bg-slate-800 rounded-2xl p-6">
            <div id="networkChart" style="width: 100%; height: 600px;"></div>
        </div>
    </div>

    <!-- Cards View -->
    <div id="cardsView" class="hidden max-w-7xl mx-auto px-6 pb-12">
        <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards will be inserted here -->
        </div>
    </div>
</div>

<!-- Add Entity Modal -->
<div id="addModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-xl font-bold"></h3>
                <button onclick="closeAddModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addForm" onsubmit="addEntity(event)">
                <div id="formFields">
                    <!-- Dynamic form fields will be inserted here -->
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="submit" 
                            class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
                        Ajouter
                    </button>
                    <button type="button" onclick="closeAddModal()" 
                            class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Link Modal -->
<div id="linkModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">Ajouter un lien</h3>
                <button onclick="closeLinkModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="linkForm" onsubmit="addLink(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">De</label>
                        <select name="from_entity" id="fromEntitySelect" required
                                class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Vers</label>
                        <select name="to_entity" id="toEntitySelect" required
                                class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Type de lien</label>
                        <input type="text" name="title" placeholder="Ex: a vu, travaille à, propriétaire de" required
                               class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description (optionnelle)</label>
                        <textarea name="description" rows="2"
                                  class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="submit" 
                            class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
                        Ajouter le lien
                    </button>
                    <button type="button" onclick="closeLinkModal()" 
                            class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Entity Detail Drawer -->
<div id="entityDetailModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden">
    <div class="flex justify-end min-h-screen">
        <div class="relative w-full max-w-xl bg-slate-900/95 border-l border-slate-700 shadow-2xl overflow-y-auto">
            <div class="sticky top-0 z-10 bg-slate-900/95 border-b border-slate-700 px-6 py-4 flex items-start justify-between">
                <div>
                    <p id="entityDetailType" class="text-xs uppercase tracking-[0.2em] text-slate-400"></p>
                    <h2 id="entityDetailTitle" class="text-2xl font-semibold text-white mt-1"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" id="entityDetailEditBtn"
                            class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors text-sm font-medium">
                        <i class="fas fa-pen mr-1"></i>Modifier
                    </button>
                    <button type="button" onclick="closeEntityDetailModal()"
                            class="text-slate-400 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="px-6 pt-6 space-y-4">
                <div id="entityDetailEmptyHint" class="bg-slate-800/70 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-300 flex items-start gap-3 hidden">
                    <i class="fas fa-lightbulb text-amber-300 mt-0.5"></i>
                    <p>Ajoutez une description structurée en utilisant <code class="bg-slate-900 px-1 py-0.5 rounded text-xs">#</code> pour les titres, <code class="bg-slate-900 px-1 py-0.5 rounded text-xs">-</code> pour les listes, ou <span class="bg-slate-900 px-1 py-0.5 rounded text-xs">**gras**</span> pour mettre en valeur les détails clés.</p>
                </div>
                <div id="entityDetailContent" class="space-y-6">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Entity Modal -->
<div id="editModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">Modifier l'élément</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editForm" onsubmit="updateEntity(event)">
                <div id="editFormFields">
                    <!-- Dynamic edit form fields will be inserted here -->
                </div>
                
                <div class="flex space-x-3 mt-6">
                        <button type="submit" 
                                class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
                            Mettre à jour
                        </button>
                        <button type="button" onclick="app.deleteEntity(app.editingEntity?.id)"
                                class="py-3 px-4 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-colors text-white">
                            Supprimer
                        </button>
                        <button type="button" onclick="closeEditModal()" 
                                class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors">
                            Annuler
                        </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Investigation App JavaScript
class InvestigationApp {
    constructor() {
        this.investigationId = '{{ investigation.id }}';
        this.currentView = 'timeline';
        this.entities = [];
        this.links = [];
        this.editingEntity = null;
    this.activeDetailEntityId = null;
        this.networkChart = null;
        this.members = [];
        this.membersLoaded = false;
        this.currentUserId = '{{ request.user.id }}';
        this.userRole = '{{ user_role }}';
        this.investigationOwnerId = '{{ investigation.created_by_id }}';
        this.isOwner = this.userRole === 'owner';
        this.activeTypeFilters = new Set();
        this.attributeFilters = {
            has_description: false,
            has_links: false
        };
        this.sortOption = 'updated_desc';
        this.searchTermRaw = '';
        this.searchTerm = '';
        this.linkCountMap = new Map();
        
        this.init();
    }
    
    init() {
        this.captureInitialFilterState();
        this.loadData();
        this.setupEventListeners();
        this.startPresence();
        this.startHeartbeat();
        this.startAutoSync();
    }

    captureInitialFilterState() {
        const searchInput = document.getElementById('searchInput');
        this.searchTermRaw = searchInput ? searchInput.value : '';
        this.searchTerm = (this.searchTermRaw || '').toLowerCase();

        const sortSelect = document.getElementById('sortSelect');
        this.sortOption = sortSelect ? sortSelect.value : 'updated_desc';

        this.resetTypeFilters(true);
        this.resetAttributeFilters(true);
        this.updateActiveFilterChips();
    }
    
    setupEventListeners() {
        // Close modals on outside click
        document.getElementById('addModal').addEventListener('click', (e) => {
            if (e.target.id === 'addModal') this.closeAddModal();
        });
        
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') this.closeEditModal();
        });
        
        document.getElementById('linkModal').addEventListener('click', (e) => {
            if (e.target.id === 'linkModal') this.closeLinkModal();
        });

        const detailModal = document.getElementById('entityDetailModal');
        if (detailModal) {
            detailModal.addEventListener('click', (e) => {
                if (e.target.id === 'entityDetailModal') {
                    this.closeEntityDetail();
                }
            });
        }

        const addTypeModal = document.getElementById('addTypeModal');
        if (addTypeModal) {
            addTypeModal.addEventListener('click', (e) => {
                if (e.target.id === 'addTypeModal') this.closeAddTypeModal();
            });
        }

        const settingsModal = document.getElementById('investigationSettingsModal');
        if (settingsModal) {
            settingsModal.addEventListener('click', (e) => {
                if (e.target.id === 'investigationSettingsModal') {
                    this.closeInvestigationSettingsModal();
                }
            });
        }

        const deleteInvestigationBtn = document.getElementById('deleteInvestigationBtn');
        if (deleteInvestigationBtn) {
            deleteInvestigationBtn.addEventListener('click', () => this.deleteInvestigation());
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                this.closeAddModal();
                this.closeEditModal();
                this.closeLinkModal();
                this.closeAddTypeModal();
                this.closeInvestigationSettingsModal();
                this.closeEntityDetail();
                document.getElementById('filterDropdown')?.classList.add('hidden');
            }
        });
    }
    
    async loadData() {
        try {
            const [entitiesResponse, linksResponse] = await Promise.all([
                fetch(`/api/investigation/${this.investigationId}/entities/`),
                fetch(`/api/investigation/${this.investigationId}/links/`)
            ]);
            
            this.entities = (await entitiesResponse.json()).entities;
            this.links = (await linksResponse.json()).links;
            this.linkCountMap = this.buildLinkCountMap();

            // Populate checkbox filters for persons, locations and events
            try {
                const persons = this.entities
                    .filter(e => e.type === 'person')
                    .sort((a, b) => a.title.localeCompare(b.title));
                const personsContainer = document.getElementById('personsList');
                if (personsContainer) {
                    personsContainer.innerHTML = '';
                    persons.forEach(p => {
                        const id = `filter_person_${p.id}`;
                        const wrapper = document.createElement('label');
                        wrapper.className = 'inline-flex items-center space-x-2 px-2 py-1 bg-slate-800/80 hover:bg-slate-700 rounded';
                        wrapper.innerHTML = `<input type="checkbox" id="${id}" value="${p.id}" onchange="applyFilters()"> <span class="text-slate-300 text-sm">${p.title}</span>`;
                        personsContainer.appendChild(wrapper);
                    });
                }

                const places = this.entities
                    .filter(e => e.type === 'location')
                    .sort((a, b) => a.title.localeCompare(b.title));
                const placesContainer = document.getElementById('placesList');
                if (placesContainer) {
                    placesContainer.innerHTML = '';
                    places.forEach(place => {
                        const id = `filter_place_${place.id}`;
                        const wrapper = document.createElement('label');
                        wrapper.className = 'flex flex-col gap-1 px-2 py-2 bg-slate-800/80 hover:bg-slate-700 rounded';
                        const subtitle = (place.address || place.location || '').trim();
                        wrapper.innerHTML = `
                            <span class="inline-flex items-center space-x-2">
                                <input type="checkbox" id="${id}" value="${place.id}" onchange="applyFilters()">
                                <span class="text-slate-300 text-sm">${place.title}</span>
                            </span>
                            ${subtitle ? `<span class="pl-6 text-xs text-slate-500">${subtitle}</span>` : ''}
                        `;
                        placesContainer.appendChild(wrapper);
                    });
                }

                const events = this.entities
                    .filter(e => e.type === 'event')
                    .sort((a, b) => a.title.localeCompare(b.title));
                const eventsContainer = document.getElementById('eventsList');
                if (eventsContainer) {
                    eventsContainer.innerHTML = '';
                    events.forEach(ev => {
                        const id = `filter_event_${ev.id}`;
                        const wrapper = document.createElement('label');
                        wrapper.className = 'inline-flex items-center space-x-2 px-2 py-1 bg-slate-800/80 hover:bg-slate-700 rounded';
                        wrapper.innerHTML = `<input type="checkbox" id="${id}" value="${ev.id}" onchange="applyFilters()"> <span class="text-slate-300 text-sm">${ev.title}</span>`;
                        eventsContainer.appendChild(wrapper);
                    });
                }
            } catch (e) {
                console.warn('Could not populate checkbox filters', e);
            }

            this.refreshView();
            this.refreshEntityDetail();
            this.updateActiveFilterChips();
            // also refresh presence immediately after loading data
            this.fetchPresence();
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    // Presence polling & heartbeat
    async fetchPresence() {
        try {
            const res = await fetch(`/api/investigation/${this.investigationId}/presence/`);
            if (!res.ok) return [];
            const data = await res.json();
            const members = data.members || [];
            this.renderPresence(members);
            return members;
        } catch (e) {
            console.error('Error fetching presence', e);
            return [];
        }
    }

    renderPresence(members) {
        const container = document.getElementById('presenceBubbles');
        if (!container) return;
        this.members = members;
    this.membersLoaded = true;
        container.innerHTML = '';
        members.forEach(m => {
            const el = document.createElement('div');
            el.className = 'relative';
            el.title = (m.username) + (m.online ? ' — en ligne' : ' — hors ligne');
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm text-white overflow-hidden';
            if (m.avatar) {
                const img = document.createElement('img');
                img.src = m.avatar;
                img.alt = m.username;
                img.className = 'w-full h-full object-cover';
                avatar.appendChild(img);
            } else {
                avatar.textContent = m.username.charAt(0).toUpperCase();
            }
            const dot = document.createElement('span');
            dot.className = 'absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-slate-900';
            dot.style.backgroundColor = m.online ? '#34d399' : '#6b7280';
            el.appendChild(avatar);
            el.appendChild(dot);
            container.appendChild(el);
        });

        if (this.isOwner) {
            this.renderMemberAccessList();
        }
    }

    renderMemberAccessList() {
        if (!this.isOwner) return;
        const container = document.getElementById('investigationMembersList');
        if (!container) return;

        if (!this.membersLoaded) {
            container.innerHTML = '<div class="text-sm text-slate-400">Chargement des membres...</div>';
            return;
        }

        if (!Array.isArray(this.members) || this.members.length === 0) {
            container.innerHTML = '<div class="text-sm text-slate-400">Aucun membre pour le moment.</div>';
            return;
        }

        const roleLabels = {
            owner: 'Propriétaire',
            admin: 'Administrateur',
            member: 'Membre',
            viewer: 'Observateur'
        };

        container.innerHTML = '';

        this.members.forEach(member => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between bg-slate-900/60 border border-slate-700 rounded-lg px-4 py-3';

            const info = document.createElement('div');
            info.className = 'flex items-center gap-3';

            const avatar = document.createElement('div');
            avatar.className = 'w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center text-sm text-white overflow-hidden';
            if (member.avatar) {
                const img = document.createElement('img');
                img.src = member.avatar;
                img.alt = member.username;
                img.className = 'w-full h-full object-cover';
                avatar.appendChild(img);
            } else {
                avatar.textContent = (member.username || '?').charAt(0).toUpperCase();
            }

            const details = document.createElement('div');
            details.className = 'flex flex-col';

            const nameLine = document.createElement('div');
            nameLine.className = 'flex items-center gap-2';
            const name = document.createElement('span');
            name.className = 'text-sm font-semibold text-slate-100';
            name.textContent = member.username || 'Utilisateur';

            const roleBadge = document.createElement('span');
            roleBadge.className = 'px-2 py-0.5 text-[11px] rounded-full bg-slate-800 text-slate-300 border border-slate-700 uppercase tracking-wide';
            roleBadge.textContent = roleLabels[member.role] || member.role;

            nameLine.appendChild(name);
            nameLine.appendChild(roleBadge);

            const status = document.createElement('span');
            status.className = `text-xs ${member.online ? 'text-emerald-400' : 'text-slate-500'}`;
            status.textContent = member.online ? 'En ligne' : 'Hors ligne';

            details.appendChild(nameLine);
            details.appendChild(status);

            info.appendChild(avatar);
            info.appendChild(details);
            row.appendChild(info);

            const canRemove = this.isOwner && member.role !== 'owner' && String(member.id) !== String(this.currentUserId);
            const actions = document.createElement('div');
            actions.className = 'flex items-center gap-2';

            if (canRemove) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'px-3 py-2 text-sm bg-red-600 hover:bg-red-700 rounded-lg text-white transition-colors flex items-center gap-2';
                removeBtn.innerHTML = '<i class="fas fa-user-slash"></i><span>Retirer l\'accès</span>';
                removeBtn.addEventListener('click', () => this.revokeMember(member.id, removeBtn));
                actions.appendChild(removeBtn);
            } else {
                const hint = document.createElement('span');
                hint.className = 'text-xs text-slate-500';
                hint.textContent = member.role === 'owner' ? 'Propriétaire' : 'Accès non modifiable';
                actions.appendChild(hint);
            }

            row.appendChild(actions);
            container.appendChild(row);
        });
    }

    isDetailOpen() {
        const modal = document.getElementById('entityDetailModal');
        return Boolean(modal && !modal.classList.contains('hidden'));
    }

    openEntityDetail(entityId) {
        const entity = this.entities.find(e => String(e.id) === String(entityId));
        if (!entity) {
            this.showNotification('Élément introuvable', 'error');
            return;
        }

        this.activeDetailEntityId = String(entity.id);
        const modal = document.getElementById('entityDetailModal');
        if (!modal) return;

        this.populateEntityDetail(entity);
        modal.classList.remove('hidden');

        const drawer = modal.querySelector('.overflow-y-auto');
        if (drawer) {
            drawer.scrollTop = 0;
        }
    }

    closeEntityDetail() {
        const modal = document.getElementById('entityDetailModal');
        if (!modal) return;
        modal.classList.add('hidden');
        this.activeDetailEntityId = null;
    }

    refreshEntityDetail() {
        if (!this.activeDetailEntityId || !this.isDetailOpen()) {
            return;
        }
        const entity = this.entities.find(e => String(e.id) === String(this.activeDetailEntityId));
        if (!entity) {
            this.closeEntityDetail();
            return;
        }
        this.populateEntityDetail(entity);
    }

    populateEntityDetail(entity) {
        const titleEl = document.getElementById('entityDetailTitle');
        const typeEl = document.getElementById('entityDetailType');
        const contentEl = document.getElementById('entityDetailContent');
        const editBtn = document.getElementById('entityDetailEditBtn');

        if (!contentEl || !titleEl || !typeEl) return;

        const typeLabels = {
            person: 'Personne',
            location: 'Lieu',
            evidence: 'Preuve',
            event: 'Événement'
        };

        titleEl.textContent = entity.title || 'Sans titre';
        typeEl.textContent = typeLabels[entity.type] || 'Élément';

        if (editBtn) {
            editBtn.onclick = () => {
                this.closeEntityDetail();
                this.editEntity(entity.id);
            };
        }

        const metaRows = this.buildEntityMetaRows(entity);
        const linkedEntities = this.getLinkedEntitiesOverview(entity.id);
        const safeLinkedEntities = linkedEntities.map(item => ({
            entity: {
                id: item.entity.id,
                type: item.entity.type,
                title: item.entity.title ? this.escapeHtml(item.entity.title) : 'Sans titre'
            },
            relations: item.relations
                .map(rel => this.escapeHtml(rel))
                .filter(Boolean)
        }));
        const descriptionHtml = entity.description
            ? this.renderMarkdown(entity.description)
            : '<p class="text-sm text-slate-500 italic">Aucune description pour le moment.</p>';

        const hasDescription = Boolean(entity.description && entity.description.trim());
        const hasMeta = metaRows.length > 0;
        const hasLinked = safeLinkedEntities.length > 0;

        const introToastEl = document.getElementById('entityDetailEmptyHint');
        if (introToastEl) {
            introToastEl.classList.toggle('hidden', hasDescription || hasMeta || hasLinked);
        }

        const metaSection = metaRows.length ? `
            <section class="space-y-3">
                <h3 class="text-sm font-semibold text-slate-300 uppercase tracking-[0.2em]">Informations clés</h3>
                <dl class="space-y-3">
                    ${metaRows.map(row => `
                        <div class="flex items-start justify-between gap-4 pb-3 border-b border-slate-800 last:border-transparent">
                            <dt class="text-xs uppercase tracking-[0.2em] text-slate-500">${row.label}</dt>
                            <dd class="text-sm text-slate-100 text-right">${row.value}</dd>
                        </div>
                    `).join('')}
                </dl>
            </section>
        ` : '';

        const descriptionSection = `
            <section class="space-y-3">
                <h3 class="text-sm font-semibold text-slate-300 uppercase tracking-[0.2em]">Description</h3>
                ${hasDescription ? `
                    <div class="prose prose-invert prose-sm max-w-none leading-relaxed">
                        ${descriptionHtml}
                    </div>
                ` : '<p class="text-sm text-slate-500 italic">Aucune description pour le moment.</p>'}
            </section>
        `;

        const linkedSection = `
            <section class="space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-slate-300 uppercase tracking-[0.2em]">Liens</h3>
                    <button type="button" class="text-xs text-blue-400 hover:text-blue-300" onclick="app.openLinkModal('${entity.id}')">
                        <i class="fas fa-plus mr-1"></i>Ajouter un lien
                    </button>
                </div>
                ${safeLinkedEntities.length ? `
                    <ul class="space-y-2">
                        ${safeLinkedEntities.map(item => `
                            <li class="bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 flex items-start justify-between gap-3">
                                <div>
                                    <div class="text-sm font-medium text-slate-100">${item.entity.title}</div>
                                    <div class="text-[11px] uppercase tracking-[0.2em] text-slate-500">${typeLabels[item.entity.type] || item.entity.type}</div>
                                    ${item.relations.length ? `<div class="mt-1 flex flex-wrap gap-1">
                                        ${item.relations.map(rel => `<span class="px-2 py-0.5 text-[11px] rounded-full bg-slate-900 border border-slate-700 text-slate-300">${rel}</span>`).join('')}
                                    </div>` : ''}
                                </div>
                                <button type="button" class="px-2 py-1 text-xs bg-slate-900/80 border border-slate-700 rounded-md hover:border-slate-500 text-slate-200"
                                        onclick="event.stopPropagation(); app.openEntityDetail('${item.entity.id}')">
                                    Ouvrir
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                ` : '<p class="text-sm text-slate-500 italic">Aucun lien pour le moment.</p>'}
            </section>
        `;

        const createdLabel = this.escapeHtml(this.formatDateTimeDisplay(entity.created_at));
        const updatedLabel = entity.updated_at ? this.escapeHtml(this.formatDateTimeDisplay(entity.updated_at)) : null;

        const auditSection = `
            <section class="space-y-2 text-xs text-slate-500">
                <div>Créé le ${createdLabel}</div>
                ${updatedLabel ? `<div>Mis à jour le ${updatedLabel}</div>` : ''}
            </section>
        `;

        contentEl.innerHTML = [metaSection, descriptionSection, linkedSection, auditSection]
            .filter(Boolean)
            .join('\n');
    }

    buildEntityMetaRows(entity) {
        const rows = [];
        const pushRow = (label, value) => {
            if (value !== null && value !== undefined && value !== '') {
                rows.push({
                    label,
                    value: this.escapeHtml(value)
                });
            }
        };

        switch (entity.type) {
            case 'person':
                pushRow('Rôle', entity.role || '—');
                break;
            case 'location':
                pushRow('Zone / Ville', entity.location || '—');
                pushRow('Adresse', entity.address || '—');
                break;
            case 'evidence':
                pushRow('Type de preuve', entity.evidence_type || '—');
                break;
            case 'event':
                pushRow('Début', this.formatDateTimeDisplay(entity.event_date));
                pushRow('Fin', this.formatDateTimeDisplay(entity.event_end_date));
                if (entity.is_timeslot) {
                    pushRow('Précision', 'Créneau approximatif');
                }
                const linkedLocations = this.getLinkedLocations(entity.id);
                if (linkedLocations.length) {
                    pushRow('Lieux associés', linkedLocations.map(loc => loc.title).join(', '));
                }
                break;
        }

        if (entity.created_by) {
            pushRow('Créé par', entity.created_by);
        }

        return rows;
    }

    formatDateTimeDisplay(value) {
        if (!value) return '—';
        try {
            const hasTime = typeof value === 'string' && value.includes('T') && value.includes(':');
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            const options = hasTime
                ? { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }
                : { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleString('fr-FR', options);
        } catch (error) {
            return value;
        }
    }

    getLinkedEntitiesOverview(entityId) {
        const targetId = String(entityId);
        const grouped = new Map();

        const addRelation = (otherEntity, label) => {
            if (!otherEntity) return;
            const key = String(otherEntity.id);
            if (!grouped.has(key)) {
                grouped.set(key, { entity: otherEntity, relations: [] });
            }
            if (label) {
                grouped.get(key).relations.push(label);
            }
        };

        this.links.forEach(link => {
            const fromId = String(link.from_entity.id);
            const toId = String(link.to_entity.id);

            if (fromId === targetId) {
                addRelation(link.to_entity, link.title || 'Lien sortant');
            } else if (toId === targetId) {
                addRelation(link.from_entity, link.title || 'Lien entrant');
            }
        });

        return Array.from(grouped.values());
    }

    renderMarkdown(text) {
        if (!text) {
            return '';
        }

        const escaped = this.escapeHtml(text).replace(/\r\n/g, '\n');
        const lines = escaped.split('\n');
        const htmlParts = [];
        let inList = false;

        const flushList = () => {
            if (inList) {
                htmlParts.push('</ul>');
                inList = false;
            }
        };

        lines.forEach(line => {
            const trimmed = line.trim();
            const headingMatch = trimmed.match(/^(#{1,6})\s+(.*)$/);
            if (headingMatch) {
                flushList();
                const level = headingMatch[1].length;
                const content = this.renderMarkdownInline(headingMatch[2]);
                htmlParts.push(`<h${level} class="text-slate-100 text-base font-semibold">${content}</h${level}>`);
                return;
            }

            if (/^[-*]\s+/.test(trimmed)) {
                if (!inList) {
                    htmlParts.push('<ul class="list-disc list-inside space-y-1">');
                    inList = true;
                }
                const item = trimmed.replace(/^[-*]\s+/, '');
                htmlParts.push(`<li>${this.renderMarkdownInline(item)}</li>`);
                return;
            }

            if (trimmed === '') {
                flushList();
                htmlParts.push('<br>');
                return;
            }

            flushList();
            htmlParts.push(`<p class="text-sm text-slate-200">${this.renderMarkdownInline(trimmed)}</p>`);
        });

        flushList();

        return htmlParts.join('\n');
    }

    renderMarkdownInline(text) {
        return text
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/`([^`]+?)`/g, '<code class="bg-slate-800 px-1 py-0.5 rounded text-xs text-blue-200">$1</code>');
    }

    escapeHtml(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    openInvestigationSettingsModal() {
        if (!this.isOwner) return;
        const modal = document.getElementById('investigationSettingsModal');
        if (!modal) return;
        modal.classList.remove('hidden');
        this.renderMemberAccessList();
        this.fetchPresence().catch(() => {});
    }

    closeInvestigationSettingsModal() {
        const modal = document.getElementById('investigationSettingsModal');
        if (!modal) return;
        modal.classList.add('hidden');
    }

    updateInvestigationCode(newCode) {
        if (!newCode) return;
        const codeBtn = document.getElementById('investigationCodeBtn');
        if (codeBtn) {
            if (codeBtn._copyTimeout) {
                clearTimeout(codeBtn._copyTimeout);
                codeBtn._copyTimeout = null;
            }
            const label = codeBtn.querySelector('[data-code-display]');
            if (label) {
                label.textContent = newCode;
            }
            codeBtn.dataset.code = newCode;
            codeBtn.dataset.originalLabel = newCode;
            codeBtn.title = `Code : ${newCode}`;

            const icon = codeBtn.querySelector('i');
            if (icon) {
                icon.classList.remove('fa-check');
                if (!icon.classList.contains('fa-copy')) {
                    icon.classList.add('fa-copy');
                }
            }

            codeBtn.classList.remove('text-emerald-300', 'border-emerald-500/60', 'bg-emerald-500/10');
            if (!codeBtn.classList.contains('text-blue-400')) {
                codeBtn.classList.add('text-blue-400');
            }
            codeBtn.classList.add('hover:text-blue-300', 'border-blue-500/40');
        }

        const settingsCode = document.getElementById('investigationSettingsCode');
        if (settingsCode) {
            settingsCode.textContent = newCode;
        }
    }

    async revokeMember(userId, buttonEl) {
        if (!this.isOwner || !userId) return;

        const confirmation = window.confirm("Retirer l'accès à cette personne ?\nLe code de l'enquête sera régénéré.");
        if (!confirmation) {
            return;
        }

        let originalContent = '';
        if (buttonEl) {
            originalContent = buttonEl.innerHTML;
            buttonEl.disabled = true;
            buttonEl.innerHTML = '<span class="flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i><span>Suppression...</span></span>';
        }

        try {
            const response = await fetch(`/api/investigation/${this.investigationId}/members/${userId}/revoke/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({})
            });

            const payload = await response.json().catch(() => ({}));

            if (!response.ok) {
                throw new Error(payload.error || "Impossible de retirer ce membre");
            }

            if (payload.code) {
                this.updateInvestigationCode(payload.code);
            }

            this.showNotification(payload.message || "Accès retiré", 'success');
            await this.fetchPresence();
        } catch (error) {
            console.error('Error revoking member:', error);
            this.showNotification(error.message || "Erreur lors du retrait d'accès", 'error');
        } finally {
            if (buttonEl) {
                buttonEl.disabled = false;
                buttonEl.innerHTML = originalContent || '<i class="fas fa-user-slash"></i><span>Retirer l\'accès</span>';
            }
        }
    }

    async deleteInvestigation() {
        if (!this.isOwner) return;

        const confirmDelete = window.confirm("Êtes-vous sûr de vouloir supprimer cette enquête ?\nCette action est irréversible.");
        if (!confirmDelete) return;

        const deleteBtn = document.getElementById('deleteInvestigationBtn');
        let originalContent = '';
        if (deleteBtn) {
            originalContent = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span class="flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i><span>Suppression...</span></span>';
        }

        try {
            const response = await fetch(`/api/investigation/${this.investigationId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            const payload = await response.json().catch(() => ({}));

            if (!response.ok) {
                throw new Error(payload.error || "Impossible de supprimer l'enquête");
            }

            const redirectUrl = payload.redirect || '/dashboard/';
            window.location.href = redirectUrl;
        } catch (error) {
            console.error('Error deleting investigation:', error);
            this.showNotification(error.message || "Erreur lors de la suppression de l'enquête", 'error');
        } finally {
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalContent || '<i class="fas fa-trash mr-2"></i>Supprimer l\'enquête';
            }
        }
    }

    startPresence() {
        // Poll presence every 5 seconds
        this._presenceInterval = setInterval(() => this.fetchPresence(), 5000);
    }

    startHeartbeat() {
        // Send heartbeat every 10 seconds
        this._heartbeat = setInterval(async () => {
            try {
                await fetch(`/api/investigation/${this.investigationId}/presence/heartbeat/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } });
            } catch (e) {
                // ignore
            }
        }, 10000);
        // send initial heartbeat
        fetch(`/api/investigation/${this.investigationId}/presence/heartbeat/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } }).catch(()=>{});
    }

    // Auto-sync polling to pick up changes from other users
    startAutoSync() {
        // Poll every 4 seconds for changes (adjust as needed)
        this._syncInterval = setInterval(() => this.fetchLatestChanges(), 4000);
        // do an initial poll shortly after load
        setTimeout(() => this.fetchLatestChanges(), 2000);
    }

    async fetchLatestChanges() {
        try {
            const [entitiesResponse, linksResponse] = await Promise.all([
                fetch(`/api/investigation/${this.investigationId}/entities/`),
                fetch(`/api/investigation/${this.investigationId}/links/`)
            ]);

            if (!entitiesResponse.ok || !linksResponse.ok) return;

            const newEntities = (await entitiesResponse.json()).entities || [];
            const newLinks = (await linksResponse.json()).links || [];

            let changed = false;

            // Quick length check
            if (newEntities.length !== this.entities.length) changed = true;

            // If same length, check updated_at for entities
            if (!changed) {
                const oldMap = {};
                this.entities.forEach(e => { oldMap[e.id] = e.updated_at || e.created_at; });
                for (const ne of newEntities) {
                    // if updated_at doesn't match or id is new/missing, mark changed
                    if (!oldMap[ne.id] || oldMap[ne.id] !== ne.updated_at) {
                        changed = true; break;
                    }
                }
            }

            // Links: check ids set or length change
            if (!changed) {
                if (newLinks.length !== this.links.length) changed = true;
                else {
                    const oldLinkIds = new Set(this.links.map(l => l.id));
                    for (const nl of newLinks) {
                        if (!oldLinkIds.has(nl.id)) { changed = true; break; }
                    }
                }
            }

            if (changed) {
                // Replace and refresh view
                this.entities = newEntities;
                this.links = newLinks;
                this.linkCountMap = this.buildLinkCountMap();
                this.refreshView();
                this.refreshEntityDetail();
                this.updateActiveFilterChips();
            }
        } catch (e) {
            console.error('Error fetching latest changes for auto-sync', e);
        }
    }
    
    toggleTypeFilter(type, forceState = null) {
        if (!type) return;
        const isActive = this.activeTypeFilters.has(type);
        const nextState = forceState === null ? !isActive : Boolean(forceState);

        if (nextState) {
            this.activeTypeFilters.add(type);
        } else {
            this.activeTypeFilters.delete(type);
        }

        this.updateTypeButtonAppearance(type, nextState);
        this.updateActiveFilterChips();
        this.refreshView();
    }

    updateTypeButtonAppearance(type, isActive) {
        const button = document.querySelector(`#filterTypeButtons [data-filter-type="${type}"]`);
        if (!button) return;

        button.classList.toggle('bg-blue-600', isActive);
        button.classList.toggle('text-white', isActive);
        button.classList.toggle('border-blue-500/60', isActive);
        button.classList.toggle('bg-slate-800/80', !isActive);
        button.classList.toggle('text-slate-300', !isActive);
        button.classList.toggle('border-slate-700', !isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    }

    resetTypeFilters(silent = false) {
        this.activeTypeFilters.clear();
        const types = ['person', 'location', 'evidence', 'event'];
        types.forEach(type => this.updateTypeButtonAppearance(type, false));

        if (!silent) {
            this.updateActiveFilterChips();
            this.refreshView();
        }
    }

    toggleAttributeFilter(key, isActive) {
        if (!(key in this.attributeFilters)) return;
        const flag = Boolean(isActive);
        this.attributeFilters[key] = flag;

        const checkboxMap = {
            has_description: 'filterHasDescription',
            has_links: 'filterHasLinks'
        };
        const checkboxId = checkboxMap[key];
        if (checkboxId) {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox && checkbox.checked !== flag) {
                checkbox.checked = flag;
            }
        }

        this.updateActiveFilterChips();
        this.refreshView();
    }

    resetAttributeFilters(silent = false) {
        Object.keys(this.attributeFilters).forEach(key => {
            this.attributeFilters[key] = false;
        });

        ['filterHasDescription', 'filterHasLinks'].forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.checked = false;
            }
        });

        if (!silent) {
            this.updateActiveFilterChips();
            this.refreshView();
        }
    }

    onSortChange(event) {
        const value = event?.target?.value || 'updated_desc';
        this.sortOption = value;
        this.refreshView();
    }

    onSearchInput(event) {
        const raw = event?.target?.value || '';
        this.searchTermRaw = raw;
        this.searchTerm = raw.toLowerCase();
        this.updateActiveFilterChips();
        this.refreshView();
    }

    updateActiveFilterChips() {
        const container = document.getElementById('activeFilterChips');
        if (!container) return;

        container.innerHTML = '';

        const typeLabels = {
            person: 'Personnes',
            location: 'Lieux',
            evidence: 'Preuves',
            event: 'Événements'
        };

        const attributeLabels = {
            has_description: 'Avec description',
            has_links: 'Avec liens'
        };

        const chips = [];

        this.activeTypeFilters.forEach(type => {
            chips.push({
                key: `type:${type}`,
                label: typeLabels[type] || type,
                onRemove: () => this.toggleTypeFilter(type, false)
            });
        });

        Object.entries(this.attributeFilters).forEach(([key, value]) => {
            if (value) {
                chips.push({
                    key: `attr:${key}`,
                    label: attributeLabels[key] || key,
                    onRemove: () => this.toggleAttributeFilter(key, false)
                });
            }
        });

        if (this.searchTermRaw && this.searchTermRaw.trim()) {
            chips.push({
                key: 'search',
                label: `Recherche : "${this.searchTermRaw.trim()}"`,
                onRemove: () => {
                    this.searchTermRaw = '';
                    this.searchTerm = '';
                    const input = document.getElementById('searchInput');
                    if (input) {
                        input.value = '';
                    }
                    this.updateActiveFilterChips();
                    this.refreshView();
                }
            });
        }

        if (!chips.length) {
            container.classList.add('hidden');
            return;
        }

        container.classList.remove('hidden');

        chips.forEach(chip => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 text-slate-200 text-xs border border-slate-600 hover:border-slate-400 transition-colors';
            button.innerHTML = `<span>${chip.label}</span><i class="fas fa-times text-[10px]"></i>`;
            button.addEventListener('click', () => chip.onRemove());
            container.appendChild(button);
        });
    }

    buildLinkCountMap() {
        const map = new Map();
        this.links.forEach(link => {
            const fromId = String(link.from_entity.id);
            const toId = String(link.to_entity.id);
            map.set(fromId, (map.get(fromId) || 0) + 1);
            map.set(toId, (map.get(toId) || 0) + 1);
        });
        return map;
    }

    entityHasLinks(entityId) {
        const key = String(entityId);
        return (this.linkCountMap.get(key) || 0) > 0;
    }

    sortEntities(entities) {
        const sorted = [...entities];
        const typeOrder = {
            person: 0,
            location: 1,
            event: 2,
            evidence: 3
        };

        const compareTitle = (a, b) => (a.title || '').localeCompare(b.title || '', 'fr', { sensitivity: 'base' });
        const getTimestamp = (value) => {
            if (!value) return 0;
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? 0 : date.getTime();
        };

        const getUpdatedTimestamp = (entity) => getTimestamp(entity.updated_at) || getTimestamp(entity.created_at);
        const getCreatedTimestamp = (entity) => getTimestamp(entity.created_at);
        const getLinkCount = (entity) => this.linkCountMap.get(String(entity.id)) || 0;

        switch (this.sortOption) {
            case 'updated_asc':
                sorted.sort((a, b) => getUpdatedTimestamp(a) - getUpdatedTimestamp(b));
                break;
            case 'created_desc':
                sorted.sort((a, b) => getCreatedTimestamp(b) - getCreatedTimestamp(a));
                break;
            case 'created_asc':
                sorted.sort((a, b) => getCreatedTimestamp(a) - getCreatedTimestamp(b));
                break;
            case 'title_asc':
                sorted.sort((a, b) => compareTitle(a, b));
                break;
            case 'title_desc':
                sorted.sort((a, b) => compareTitle(b, a));
                break;
            case 'type_asc':
                sorted.sort((a, b) => {
                    const diff = (typeOrder[a.type] ?? 99) - (typeOrder[b.type] ?? 99);
                    return diff !== 0 ? diff : compareTitle(a, b);
                });
                break;
            case 'links_desc':
                sorted.sort((a, b) => {
                    const diff = getLinkCount(b) - getLinkCount(a);
                    return diff !== 0 ? diff : compareTitle(a, b);
                });
                break;
            case 'updated_desc':
            default:
                sorted.sort((a, b) => getUpdatedTimestamp(b) - getUpdatedTimestamp(a));
                break;
        }

        return sorted;
    }
    
    switchView(view) {
        this.currentView = view;
        
        // Update button states
        document.querySelectorAll('#timelineBtn, #networkBtn, #cardsBtn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-slate-700', 'text-slate-300');
        });
        
        // Hide all views
        document.getElementById('timelineView').classList.add('hidden');
        document.getElementById('networkView').classList.add('hidden');
        document.getElementById('cardsView').classList.add('hidden');
        
        // Show selected view
        switch(view) {
            case 'timeline':
                document.getElementById('timelineBtn').classList.remove('bg-slate-700', 'text-slate-300');
                document.getElementById('timelineBtn').classList.add('bg-blue-600', 'text-white');
                document.getElementById('timelineView').classList.remove('hidden');
                this.renderTimeline();
                break;
            case 'network':
                document.getElementById('networkBtn').classList.remove('bg-slate-700', 'text-slate-300');
                document.getElementById('networkBtn').classList.add('bg-blue-600', 'text-white');
                document.getElementById('networkView').classList.remove('hidden');
                this.renderNetwork();
                break;
            case 'cards':
                document.getElementById('cardsBtn').classList.remove('bg-slate-700', 'text-slate-300');
                document.getElementById('cardsBtn').classList.add('bg-blue-600', 'text-white');
                document.getElementById('cardsView').classList.remove('hidden');
                this.renderCards();
                break;
        }
    }
    
    refreshView() {
        this.switchView(this.currentView);
    }
    
    getFilteredEntities() {
    const searchTerm = (this.searchTerm || '').trim();
    const normalizedSearch = searchTerm.toLowerCase();

        const personChecks = Array.from(document.querySelectorAll('#personsList input[type=checkbox]:checked')).map(i => i.value);
        const placeChecks = Array.from(document.querySelectorAll('#placesList input[type=checkbox]:checked')).map(i => i.value);
        const eventChecks = Array.from(document.querySelectorAll('#eventsList input[type=checkbox]:checked')).map(i => i.value);

        const forceTimelineEvent = (this.currentView === 'timeline');

        const selectedPersons = new Set(personChecks.map(String));
        const selectedPlaces = new Set(placeChecks.map(String));
        const selectedEvents = new Set(eventChecks.map(String));

        const focusIds = new Set([...selectedPersons, ...selectedPlaces]);

        let filtered = [...this.entities];

        if (focusIds.size > 0) {
            const linkedIds = new Set(focusIds);
            this.links.forEach(link => {
                const fromId = String(link.from_entity.id);
                const toId = String(link.to_entity.id);
                if (focusIds.has(fromId) || focusIds.has(toId)) {
                    linkedIds.add(fromId);
                    linkedIds.add(toId);
                }
            });

            filtered = filtered.filter(entity => linkedIds.has(String(entity.id)));
        }

        if (this.activeTypeFilters.size > 0) {
            filtered = filtered.filter(entity => this.activeTypeFilters.has(entity.type));
        }

        filtered = filtered.filter(entity => {
            const entityId = String(entity.id);
            if (forceTimelineEvent && entity.type !== 'event') return false;

            const linkedLocations = this.getLinkedLocations(entityId);

            if (selectedPlaces.size > 0) {
                if (entity.type === 'location') {
                    if (!selectedPlaces.has(entityId)) {
                        return false;
                    }
                } else if (!selectedPersons.has(entityId)) {
                    const linkedIds = linkedLocations.map(loc => String(loc.id));
                    if (!linkedIds.some(id => selectedPlaces.has(id))) {
                        return false;
                    }
                }
            }

            if (selectedEvents.size > 0 && entity.type === 'event' && !selectedEvents.has(entityId)) {
                return false;
            }

            if (this.attributeFilters.has_description) {
                if (!(entity.description && entity.description.trim().length > 0)) {
                    return false;
                }
            }

            if (this.attributeFilters.has_links && !this.entityHasLinks(entityId)) {
                return false;
            }

            if (searchTerm) {
                const searchPool = [
                    entity.title || '',
                    entity.description || '',
                    entity.location || '',
                    entity.event_end_date || '',
                    entity.address || '',
                    entity.role || '',
                    ...linkedLocations.map(loc => `${loc.title} ${loc.address || ''}`)
                ].join(' ').toLowerCase();
                if (!searchPool.includes(normalizedSearch)) {
                    return false;
                }
            }

            return true;
        });

        return this.sortEntities(filtered);
    }
    
    getLinkedLocations(entityId) {
        const targetId = String(entityId);
        const seen = new Set();
        const locations = [];

        this.links.forEach(link => {
            const fromId = String(link.from_entity.id);
            const toId = String(link.to_entity.id);

            if (fromId === targetId && link.to_entity.type === 'location') {
                if (!seen.has(link.to_entity.id)) {
                    seen.add(link.to_entity.id);
                    locations.push(link.to_entity);
                }
            }

            if (toId === targetId && link.from_entity.type === 'location') {
                if (!seen.has(link.from_entity.id)) {
                    seen.add(link.from_entity.id);
                    locations.push(link.from_entity);
                }
            }
        });

        return locations;
    }
    
    renderTimeline() {
        const calendar = document.getElementById('timelineContainer');
        const axisEl = document.getElementById('timelineAxis');
        const eventsLayer = document.getElementById('timelineEvents');
        const inner = document.getElementById('timelineCalendarInner');
        const emptyState = document.getElementById('timelineEmptyState');

        if (!calendar || !axisEl || !eventsLayer || !inner || !emptyState) {
            return;
        }

    const MS_IN_MINUTE = 60000;
    const MS_IN_HOUR = 60 * MS_IN_MINUTE;
    const POINT_DURATION_MS = 45 * MS_IN_MINUTE;
    const POINT_EVENT_MIN_WIDTH = 160;

        const parseDate = (value) => {
            if (!value) return null;
            const parsed = new Date(value);
            return Number.isNaN(parsed.getTime()) ? null : parsed;
        };

        const filteredEntities = this.getFilteredEntities();
        const normalizedEvents = filteredEntities
            .filter(entity => entity.type === 'event' && entity.event_date)
            .map(entity => {
                const start = parseDate(entity.event_date);
                if (!start) return null;

                let end = parseDate(entity.event_end_date);
                const hasDuration = Boolean(end && end > start);
                if (!hasDuration) {
                    end = null;
                }

                const visualEnd = hasDuration ? end : new Date(start.getTime() + POINT_DURATION_MS);

                return {
                    raw: entity,
                    start,
                    end,
                    visualEnd,
                    hasDuration
                };
            })
            .filter(Boolean)
            .sort((a, b) => a.start - b.start);

        if (normalizedEvents.length === 0) {
            axisEl.innerHTML = '';
            eventsLayer.innerHTML = '';
            inner.style.width = '100%';
            axisEl.style.width = '100%';
            eventsLayer.style.width = '100%';
            calendar.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        calendar.classList.remove('hidden');

        let minStart = normalizedEvents[0].start;
        let maxEnd = normalizedEvents[0].visualEnd;

        normalizedEvents.forEach(evt => {
            if (evt.start < minStart) minStart = evt.start;
            if (evt.visualEnd > maxEnd) maxEnd = evt.visualEnd;
        });

        const minStartMs = minStart.getTime();
        const maxEndMs = maxEnd.getTime();
        const totalDurationMs = Math.max(maxEndMs - minStartMs, MS_IN_HOUR);
        const totalHours = totalDurationMs / MS_IN_HOUR;
        const pxPerHour = totalHours <= 6 ? 220 : totalHours <= 12 ? 180 : 140;
        const minWidth = Math.max(calendar.clientWidth || 800, 600);
        const timelineWidth = Math.max(totalHours * pxPerHour, minWidth);

        inner.style.width = `${timelineWidth}px`;
        axisEl.style.width = `${timelineWidth}px`;
        eventsLayer.style.width = `${timelineWidth}px`;

        axisEl.innerHTML = '';
        eventsLayer.innerHTML = '';

        const selectTickDefinition = (hoursSpan) => {
            if (hoursSpan <= 6) {
                return { stepMinutes: 30, labelOptions: { hour: '2-digit', minute: '2-digit' }, isMajor: date => date.getHours() % 2 === 0 && date.getMinutes() === 0 };
            }
            if (hoursSpan <= 12) {
                return { stepMinutes: 60, labelOptions: { hour: '2-digit', minute: '2-digit' }, isMajor: date => date.getHours() % 3 === 0 };
            }
            if (hoursSpan <= 48) {
                return { stepMinutes: 180, labelOptions: { weekday: 'short', hour: '2-digit' }, isMajor: date => date.getHours() === 0 };
            }
            if (hoursSpan <= 24 * 7) {
                return { stepMinutes: 720, labelOptions: { weekday: 'short', day: 'numeric', hour: '2-digit' }, isMajor: date => date.getHours() === 0 };
            }
            if (hoursSpan <= 24 * 30) {
                return { stepMinutes: 1440, labelOptions: { weekday: 'short', day: 'numeric' }, isMajor: date => date.getDay() === 1 };
            }
            return { stepMinutes: 10080, labelOptions: { day: 'numeric', month: 'short' }, isMajor: date => date.getDate() <= 7 };
        };

        const tickDef = selectTickDefinition(totalHours);
        const stepMs = tickDef.stepMinutes * MS_IN_MINUTE;
        const tickFormatter = new Intl.DateTimeFormat('fr-FR', tickDef.labelOptions);

        const tickSet = new Set([minStartMs, maxEndMs]);
        let currentMs = Math.floor(minStartMs / stepMs) * stepMs;
        if (currentMs < minStartMs) currentMs += stepMs;

        while (currentMs <= maxEndMs) {
            tickSet.add(currentMs);
            currentMs += stepMs;
        }

        const tickTimes = Array.from(tickSet).sort((a, b) => a - b);
        const axisFragment = document.createDocumentFragment();
        const gridFragment = document.createDocumentFragment();

        tickTimes.forEach(tickMs => {
            const ratio = (tickMs - minStartMs) / totalDurationMs;
            const position = Math.min(Math.max(ratio * timelineWidth, 0), timelineWidth);
            const date = new Date(tickMs);

            const tick = document.createElement('div');
            tick.className = 'timeline-axis-tick';
            if (tickDef.isMajor(date)) {
                tick.classList.add('major');
            }
            tick.style.left = `${position}px`;
            axisFragment.appendChild(tick);

            const label = document.createElement('div');
            label.className = 'timeline-axis-label';
            label.style.left = `${position}px`;
            label.textContent = tickFormatter.format(date);
            axisFragment.appendChild(label);

            const grid = document.createElement('div');
            grid.className = 'timeline-gridline';
            grid.style.left = `${position}px`;
            gridFragment.appendChild(grid);
        });

        axisEl.appendChild(axisFragment);
        eventsLayer.appendChild(gridFragment);

        const includeDateInLabel = totalDurationMs > 12 * MS_IN_HOUR;
        const dateFormatter = includeDateInLabel ? new Intl.DateTimeFormat('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }) : null;
        const timeFormatter = new Intl.DateTimeFormat('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const fullDateFormatter = new Intl.DateTimeFormat('fr-FR', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });

        const formatMoment = (date) => {
            if (!date) return '';
            const timePart = timeFormatter.format(date);
            if (!includeDateInLabel || !dateFormatter) {
                return timePart;
            }
            return `${dateFormatter.format(date)} · ${timePart}`;
        };

        const formatMomentWithFallback = (date, isDateOnly) => {
            if (!date) return '';
            if (isDateOnly) {
                return fullDateFormatter.format(date);
            }
            return formatMoment(date);
        };

        const lanes = [];
        const eventsFragment = document.createDocumentFragment();
        const laneHeight = 92;

        normalizedEvents.forEach(evt => {
            const startMs = evt.start.getTime();
            const visualEndMs = evt.visualEnd.getTime();
            const endMs = evt.end ? evt.end.getTime() : visualEndMs;
            const ratioStart = (startMs - minStartMs) / totalDurationMs;
            const rawWidthRatio = (visualEndMs - startMs) / totalDurationMs;
            const linkedLocations = this.getLinkedLocations(evt.raw.id);

            let laneIndex = lanes.findIndex(laneEnd => startMs >= laneEnd);
            if (laneIndex === -1) {
                lanes.push(visualEndMs);
                laneIndex = lanes.length - 1;
            } else {
                lanes[laneIndex] = visualEndMs;
            }

            let width;
            if (evt.hasDuration) {
                width = Math.max(rawWidthRatio * timelineWidth, 24);
            } else {
                width = POINT_EVENT_MIN_WIDTH;
            }

            const left = Math.max(ratioStart * timelineWidth, 0);
            width = Math.min(width, Math.max(timelineWidth - left, 0));
            width = Math.max(width, 12);

            let blockLeft = left;
            if (blockLeft + width > timelineWidth) {
                blockLeft = Math.max(timelineWidth - width, 0);
            }

            const eventBlock = document.createElement('div');
            eventBlock.className = 'timeline-event';
            if (evt.raw.is_timeslot) {
                eventBlock.classList.add('timeslot');
            }
            if (!evt.hasDuration) {
                eventBlock.classList.add('point');
            }

            const rawStartDate = evt.raw.event_date || '';
            const rawEndDate = evt.raw.event_end_date || '';
            const isDateOnlyStart = Boolean(rawStartDate && !rawStartDate.includes('T') && !rawStartDate.includes(':'));
            const isDateOnlyEnd = Boolean(rawEndDate && !rawEndDate.includes('T') && !rawEndDate.includes(':'));

            const startLabel = formatMomentWithFallback(evt.start, isDateOnlyStart);
            const endLabel = evt.hasDuration ? formatMomentWithFallback(new Date(endMs), isDateOnlyEnd) : '';
            const timeLabel = evt.hasDuration ? `${startLabel} → ${endLabel}` : startLabel;

            const locationNames = linkedLocations.map(loc => loc.title).filter(Boolean);
            const metaSegments = [];

            if (evt.raw.is_timeslot) {
                metaSegments.push('<span>Créneau approximatif</span>');
            }
            if (!evt.hasDuration && isDateOnlyStart) {
                metaSegments.push('<span>Heure non précisée</span>');
            }
            if (locationNames.length) {
                metaSegments.push(`<span><i class="fas fa-map-marker-alt mr-1"></i>${locationNames.join(', ')}</span>`);
            }

            const tooltipParts = [evt.raw.title || 'Événement'];
            if (locationNames.length) {
                tooltipParts.push(locationNames.join(', '));
            }
            tooltipParts.push(timeLabel);

            eventBlock.dataset.title = tooltipParts.filter(Boolean).join(' • ');
            eventBlock.dataset.eventId = evt.raw.id;
            eventBlock.style.left = `${blockLeft}px`;
            eventBlock.style.top = `${laneIndex * laneHeight}px`;
            eventBlock.style.width = `${Math.max(width, 4)}px`;
            eventBlock.setAttribute('tabindex', '0');
            eventBlock.title = timeLabel;

            const descriptionMarkup = evt.raw.description
                ? `<p class="text-xs text-slate-100/80 leading-snug overflow-hidden" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">${evt.raw.description}</p>`
                : '';

            eventBlock.innerHTML = `
                <div class="timeline-event-content">
                    <div class="timeline-event-title">${evt.raw.title || 'Sans titre'}</div>
                    <div class="timeline-event-time">${timeLabel}</div>
                    ${metaSegments.length ? `<div class="timeline-event-meta">${metaSegments.join('<span class=\"opacity-60\">•</span>')}</div>` : ''}
                    ${descriptionMarkup}
                </div>
            `;

            eventBlock.addEventListener('click', () => {
                this.openEntityDetail(evt.raw.id);
            });

            eventBlock.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.openEntityDetail(evt.raw.id);
                }
            });

            eventsFragment.appendChild(eventBlock);
        });

        eventsLayer.appendChild(eventsFragment);
        eventsLayer.style.height = `${Math.max(lanes.length, 1) * laneHeight}px`;
    }
    
    renderNetwork() {
        if (!this.networkChart) {
            this.networkChart = echarts.init(document.getElementById('networkChart'));
        }
        
        const filteredEntities = this.getFilteredEntities();
        
        if (filteredEntities.length === 0) {
            this.networkChart.setOption({
                title: {
                    text: 'Aucune donnée à afficher',
                    left: 'center',
                    top: 'middle',
                    textStyle: {
                        color: '#94a3b8',
                        fontSize: 18
                    }
                }
            });
            return;
        }
        
        const nodes = [];
        const links = [];
        const nodeIds = new Set();
        
        // Create nodes
        filteredEntities.forEach(entity => {
            const nodeId = entity.id;
            let symbolSize = 30;
            let color = '#60a5fa';
            
            switch(entity.type) {
                case 'person':
                    color = '#34d399';
                    symbolSize = 40;
                    break;
                case 'location':
                    color = '#f97316';
                    symbolSize = 38;
                    break;
                case 'evidence':
                    color = '#fbbf24';
                    symbolSize = 35;
                    break;
                case 'event':
                    color = '#a78bfa';
                    symbolSize = 45;
                    break;
            }
            
            nodes.push({
                id: nodeId,
                name: entity.title,
                category: entity.type,
                symbolSize: symbolSize,
                itemStyle: {
                    color: color
                }
            });
            
            nodeIds.add(nodeId);
        });
        
        // Create links from our links data
        this.links.forEach(link => {
            if (nodeIds.has(link.from_entity.id) && nodeIds.has(link.to_entity.id)) {
                links.push({
                    source: link.from_entity.id,
                    target: link.to_entity.id,
                    name: link.title,
                    lineStyle: {
                        color: '#60a5fa',
                        opacity: 0.6,
                        width: 2
                    }
                });
            }
        });
        
        const nodeCount = filteredEntities.length;
        const repulsion = Math.min(480, 140 + nodeCount * 22);
        const edgeLength = Math.min(260, 160 + Math.max(0, nodeCount - 4) * 6);

        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.dataType === 'node') {
                        return `<strong>${params.data.name}</strong><br/>Type: ${params.data.category}`;
                    } else {
                        return `Lien: ${params.data.name}`;
                    }
                },
                backgroundColor: '#1e293b',
                borderColor: '#475569',
                textStyle: {
                    color: '#e2e8f0'
                }
            },
            legend: {
                data: ['person', 'location', 'evidence', 'event'],
                orient: 'vertical',
                left: 'left',
                top: 'top',
                textStyle: {
                    color: '#94a3b8'
                }
            },
            series: [{
                type: 'graph',
                layout: 'force',
                zoom: 1.18,
                center: ['50%', '50%'],
                data: nodes,
                links: links,
                categories: [
                    { name: 'person', itemStyle: { color: '#34d399' } },
                    { name: 'location', itemStyle: { color: '#f97316' } },
                    { name: 'evidence', itemStyle: { color: '#fbbf24' } },
                    { name: 'event', itemStyle: { color: '#a78bfa' } }
                ],
                roam: true,
                force: {
                    repulsion: repulsion,
                    gravity: 0.08,
                    edgeLength: edgeLength,
                    layoutAnimation: true
                },
                label: {
                    show: true,
                    position: 'bottom',
                    formatter: '{b}',
                    color: '#e2e8f0',
                    fontSize: 12
                },
                emphasis: {
                    focus: 'adjacency',
                    lineStyle: {
                        width: 4
                    }
                }
            }]
        };
        
        this.networkChart.setOption(option);
    }
    
    renderCards() {
        const container = document.getElementById('cardsContainer');
        const filteredEntities = this.getFilteredEntities();
        
        if (filteredEntities.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-inbox text-4xl text-slate-600 mb-4"></i>
                    <p class="text-slate-400">Aucun élément à afficher</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filteredEntities.map(entity => {
            let icon = '';
            let color = '';
            let content = '';
            
            switch(entity.type) {
                case 'person':
                    icon = 'fas fa-user';
                    color = 'green';
                    content = `
                        <h3 class="text-xl font-bold text-white mb-2">${entity.title}</h3>
                        ${entity.role ? `<p class="text-green-400 text-sm mb-2">${entity.role}</p>` : ''}
                        ${entity.description ? `<p class="text-slate-300 text-sm mb-4">${entity.description}</p>` : ''}
                    `;
                    break;
                case 'location':
                    icon = 'fas fa-map-marker-alt';
                    color = 'amber';
                    content = `
                        <h3 class="text-xl font-bold text-white mb-2">${entity.title}</h3>
                        ${entity.location ? `<p class="text-amber-400 text-sm mb-2"><i class="fas fa-map-pin mr-1"></i>${entity.location}</p>` : ''}
                        ${entity.address ? `<p class="text-slate-400 text-sm mb-2">${entity.address}</p>` : ''}
                        ${entity.description ? `<p class="text-slate-300 text-sm mb-4">${entity.description}</p>` : ''}
                    `;
                    break;
                case 'evidence':
                    icon = 'fas fa-file-alt';
                    color = 'yellow';
                    content = `
                        <h3 class="text-xl font-bold text-white mb-2">${entity.title}</h3>
                        ${entity.evidence_type ? `<p class="text-yellow-400 text-sm mb-2">${entity.evidence_type}</p>` : ''}
                        ${entity.description ? `<p class="text-slate-300 text-sm mb-4">${entity.description}</p>` : ''}
                    `;
                    break;
                case 'event': {
                    icon = 'fas fa-calendar';
                    color = 'purple';
                    const eventLocations = this.getLinkedLocations(entity.id);
                    const locationChips = eventLocations.length ? `
                        <div class="flex flex-wrap gap-2 mb-2">
                            ${eventLocations.map(loc => `
                                <span class="inline-flex items-center px-2 py-1 bg-amber-600/20 text-amber-300 text-xs rounded-full">
                                    <i class="fas fa-map-marker-alt mr-1"></i>${loc.title}
                                </span>
                            `).join('')}
                        </div>
                    ` : '';
                    const startDate = entity.event_date ? new Date(entity.event_date) : null;
                    const endDate = entity.event_end_date ? new Date(entity.event_end_date) : null;
                    const hasDuration = Boolean(startDate && endDate);
                    const formatOptions = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                    const startLabel = startDate ? startDate.toLocaleString('fr-FR', formatOptions) : null;
                    const endLabel = endDate ? endDate.toLocaleString('fr-FR', formatOptions) : null;
                    const dateMarkup = startLabel ? (
                        hasDuration
                            ? `<p class="text-purple-300 text-sm mb-2">Du ${startLabel}<br><span class="text-purple-200">au ${endLabel}</span></p>`
                            : `<p class="text-purple-300 text-sm mb-2">${entity.is_timeslot ? 'Créneau le' : 'Le'} ${startLabel}</p>`
                    ) : '<p class="text-purple-300 text-sm mb-2">Date non précisée</p>';
                    const metaTags = [
                        hasDuration ? '<span class="px-2 py-1 text-xs rounded-full bg-emerald-500/20 text-emerald-200">Durée</span>' : '',
                        entity.is_timeslot ? '<span class="px-2 py-1 text-xs rounded-full bg-sky-500/20 text-sky-200">Créneau approximatif</span>' : ''
                    ].filter(Boolean);
                    const metaMarkup = metaTags.length ? `<div class="flex flex-wrap gap-2 mb-2">${metaTags.join('')}</div>` : '';
                    content = `
                        <h3 class="text-xl font-bold text-white mb-2">${entity.title}</h3>
                        ${dateMarkup}
                        ${metaMarkup}
                        ${locationChips}
                        ${entity.description ? `<p class="text-slate-300 text-sm mb-4">${entity.description}</p>` : ''}
                    `;
                    break;
                }
            }
            
            return `
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-${color}-500 transition-all duration-300 transform hover:scale-105 cursor-pointer focus-within:ring-2 focus-within:ring-${color}-500/60"
                     role="button"
                     tabindex="0"
                     onclick="app.openEntityDetail('${entity.id}')"
                     onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();app.openEntityDetail('${entity.id}');}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-${color}-600 rounded-lg flex items-center justify-center">
                            <i class="${icon} text-white text-xl"></i>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="event.stopPropagation(); app.editEntity('${entity.id}')"
                                    class="p-2 text-blue-400 hover:text-blue-300 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${content}
                    
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <p class="text-xs text-slate-500">
                            Créé le ${new Date(entity.created_at).toLocaleDateString('fr-FR')}
                        </p>
                    </div>
                </div>
            `;
        }).join('');
        
        // Animate cards
        anime({
            targets: '#cardsContainer > div',
            translateY: [50, 0],
            opacity: [0, 1],
            delay: anime.stagger(100),
            duration: 600,
            easing: 'easeOutExpo'
        });
    }
    
    openAddModal(type) {
        const modal = document.getElementById('addModal');
        const title = document.getElementById('modalTitle');
        const fields = document.getElementById('formFields');
        
        let fieldHTML = '';
        let modalTitle = '';
        
        switch(type) {
            case 'person':
                modalTitle = 'Ajouter une personne';
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nom</label>
                            <input type="text" name="title" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Rôle</label>
                            <input type="text" name="role" 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
                        </div>
                    </div>
                `;
                break;
            case 'location':
                modalTitle = 'Ajouter un lieu';
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nom du lieu</label>
                            <input type="text" name="title" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Zone / Ville</label>
                            <input type="text" name="location" 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Adresse</label>
                            <input type="text" name="address" 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
                        </div>
                    </div>
                `;
                break;
            case 'evidence':
                modalTitle = 'Ajouter une preuve';
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Titre</label>
                            <input type="text" name="title" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Type</label>
                            <select name="evidence_type" 
                                    class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="document">Document</option>
                                <option value="photo">Photo</option>
                                <option value="video">Vidéo</option>
                                <option value="audio">Audio</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
                        </div>
                    </div>
                `;
                break;
            case 'event':
                modalTitle = 'Ajouter un événement';
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Titre</label>
                            <input type="text" name="title" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Début</label>
                            <input type="datetime-local" name="event_date" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Fin (optionnel)</label>
                            <input type="datetime-local" name="event_end_date"
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
                        </div>
                        <label class="flex items-center space-x-3 text-sm text-slate-300">
                            <input type="checkbox" name="is_timeslot" class="h-4 w-4 text-blue-500 border border-slate-500 rounded">
                            <span>Cet événement est un créneau approximatif</span>
                        </label>
                        <p class="text-xs text-slate-400">Associez ensuite un lieu via le bouton « Lien ».</p>
                    </div>
                `;
                break;
        }
        
        title.textContent = modalTitle;
        fields.innerHTML = fieldHTML;
        modal.dataset.type = type;
        modal.classList.remove('hidden');
    }
    
    closeAddModal() {
        document.getElementById('addModal').classList.add('hidden');
    }

    openAddTypeModal() {
        document.getElementById('addTypeModal')?.classList.remove('hidden');
    }

    closeAddTypeModal() {
        document.getElementById('addTypeModal')?.classList.add('hidden');
    }
    
    async addEntity(event) {
        event.preventDefault();
        
        const modal = document.getElementById('addModal');
        const type = modal.dataset.type;
        const formData = new FormData(event.target);
        
        const data = {
            type: type,
            title: formData.get('title'),
            description: formData.get('description') || '',
            role: formData.get('role') || '',
            location: formData.get('location') || '',
            address: formData.get('address') || '',
            event_date: formData.get('event_date') || null,
            event_end_date: formData.get('event_end_date') || null,
            is_timeslot: formData.get('is_timeslot') === 'on',
            evidence_type: formData.get('evidence_type') || ''
        };
        
        try {
            const response = await fetch(`/api/investigation/${this.investigationId}/entities/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                this.closeAddModal();
                await this.loadData();
                this.showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} ajouté(e) avec succès !`, 'success');
            } else {
                throw new Error('Failed to add entity');
            }
        } catch (error) {
            console.error('Error adding entity:', error);
            this.showNotification('Erreur lors de l\'ajout', 'error');
        }
    }
    
    async openLinkModal(entityId = null) {
        if (this.isDetailOpen()) {
            this.closeEntityDetail();
        }
        const modal = document.getElementById('linkModal');
        const fromSelect = document.getElementById('fromEntitySelect');
        const toSelect = document.getElementById('toEntitySelect');
        
        // Populate entity selects
        const options = this.entities.map(entity => {
            const labels = {
                person: 'Personne',
                location: 'Lieu',
                evidence: 'Preuve',
                event: 'Événement'
            };
            const typeLabel = labels[entity.type] || entity.type;
            return `<option value="${entity.id}">${entity.title} (${typeLabel})</option>`;
        }).join('');
        
        fromSelect.innerHTML = options;
        toSelect.innerHTML = options;
        
        if (entityId) {
            fromSelect.value = entityId;
        }
        
        modal.classList.remove('hidden');
    }
    
    closeLinkModal() {
        document.getElementById('linkModal').classList.add('hidden');
    }
    
    async addLink(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const data = {
            from_entity_id: formData.get('from_entity'),
            to_entity_id: formData.get('to_entity'),
            title: formData.get('title'),
            description: formData.get('description') || ''
        };
        
        if (data.from_entity_id === data.to_entity_id) {
            this.showNotification('Impossible de créer un lien vers la même entité', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/investigation/${this.investigationId}/links/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                this.closeLinkModal();
                await this.loadData();
                this.showNotification('Lien créé avec succès !', 'success');
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to add link');
            }
        } catch (error) {
            console.error('Error adding link:', error);
            this.showNotification(error.message || 'Erreur lors de la création du lien', 'error');
        }
    }
    
    async editEntity(id) {
        const entity = this.entities.find(e => e.id === id);
        if (!entity) return;
        
        this.editingEntity = entity;
        const modal = document.getElementById('editModal');
        const fields = document.getElementById('editFormFields');
        
        let fieldHTML = '';
        
        switch(entity.type) {
            case 'person':
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nom</label>
                            <input type="text" name="title" value="${entity.title}" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Rôle</label>
                            <input type="text" name="role" value="${entity.role || ''}" 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">${entity.description || ''}</textarea>
                        </div>
                    </div>
                `;
                break;
            case 'location':
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nom du lieu</label>
                            <input type="text" name="title" value="${entity.title}" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Zone / Ville</label>
                            <input type="text" name="location" value="${entity.location || ''}" 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Adresse</label>
                            <input type="text" name="address" value="${entity.address || ''}" 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">${entity.description || ''}</textarea>
                        </div>
                    </div>
                `;
                break;
            case 'evidence':
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Titre</label>
                            <input type="text" name="title" value="${entity.title}" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Type</label>
                            <select name="evidence_type" 
                                    class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="document" ${entity.evidence_type === 'document' ? 'selected' : ''}>Document</option>
                                <option value="photo" ${entity.evidence_type === 'photo' ? 'selected' : ''}>Photo</option>
                                <option value="video" ${entity.evidence_type === 'video' ? 'selected' : ''}>Vidéo</option>
                                <option value="audio" ${entity.evidence_type === 'audio' ? 'selected' : ''}>Audio</option>
                                <option value="other" ${entity.evidence_type === 'other' ? 'selected' : ''}>Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">${entity.description || ''}</textarea>
                        </div>
                    </div>
                `;
                break;
            case 'event':
                fieldHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Titre</label>
                            <input type="text" name="title" value="${entity.title}" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Début</label>
                            <input type="datetime-local" name="event_date" value="${entity.event_date ? entity.event_date.replace('Z', '').slice(0, 16) : ''}" required 
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Fin (optionnel)</label>
                            <input type="datetime-local" name="event_end_date" value="${entity.event_end_date ? entity.event_end_date.replace('Z', '').slice(0, 16) : ''}"
                                   class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3"
                                      class="w-full px-4 py-3 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">${entity.description || ''}</textarea>
                        </div>
                        <label class="flex items-center space-x-3 text-sm text-slate-300">
                            <input type="checkbox" name="is_timeslot" ${entity.is_timeslot ? 'checked' : ''} class="h-4 w-4 text-blue-500 border border-slate-500 rounded">
                            <span>Cet événement est un créneau approximatif</span>
                        </label>
                        <p class="text-xs text-slate-400">Associez un lieu à l'événement via un lien dédié.</p>
                    </div>
                `;
                break;
        }
        
        fields.innerHTML = fieldHTML;
        modal.classList.remove('hidden');
    }
    
    closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        this.editingEntity = null;
    }
    
    async updateEntity(event) {
        event.preventDefault();
        
        if (!this.editingEntity) return;
        
        const formData = new FormData(event.target);
        const data = {
            title: formData.get('title'),
            description: formData.get('description') || '',
            role: formData.get('role') || '',
            location: formData.get('location') || '',
            address: formData.get('address') || '',
            event_date: formData.get('event_date') || null,
            event_end_date: formData.get('event_end_date') || null,
            is_timeslot: formData.get('is_timeslot') === 'on',
            evidence_type: formData.get('evidence_type') || ''
        };
        
        try {
            const response = await fetch(`/api/investigation/${this.investigationId}/entity/${this.editingEntity.id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                this.closeEditModal();
                await this.loadData();
                this.showNotification('Élément mis à jour avec succès !', 'success');
            } else {
                throw new Error('Failed to update entity');
            }
        } catch (error) {
            console.error('Error updating entity:', error);
            this.showNotification('Erreur lors de la mise à jour', 'error');
        }
    }
    
    async deleteEntity(id) {
        if (!id) return;
        if (!confirm('Êtes-vous sûr de vouloir supprimer cet élément ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/investigation/${this.investigationId}/entity/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (response.ok) {
                this.closeEditModal();
                await this.loadData();
                this.showNotification('Élément supprimé avec succès !', 'success');
            } else {
                throw new Error('Failed to delete entity');
            }
        } catch (error) {
            console.error('Error deleting entity:', error);
            this.showNotification('Erreur lors de la suppression', 'error');
        }
    }
    
    applyFilters() {
        this.refreshView();
        this.updateActiveFilterChips();
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ${
            type === 'success' ? 'bg-green-600' : 
            type === 'error' ? 'bg-red-600' : 'bg-blue-600'
        } text-white`;
        
        notification.innerHTML = `
            <div class="flex items-center space-x-3">
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation' : 'fa-info'} text-xl"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
}

// Global functions
function switchView(view) {
    app.switchView(view);
}

function openAddModal(type) {
    app.openAddModal(type);
}

function closeAddModal() {
    app.closeAddModal();
}

function addEntity(event) {
    app.addEntity(event);
}

function editEntity(id) {
    app.editEntity(id);
}

function closeEditModal() {
    app.closeEditModal();
}

function updateEntity(event) {
    app.updateEntity(event);
}

function deleteEntity(id) {
    app.deleteEntity(id);
}

function applyFilters() {
    app.applyFilters();
}

function clearFilters() {
    document.querySelectorAll('#filterDropdown input[type=checkbox]').forEach(cb => { cb.checked = false; });
    const search = document.getElementById('searchInput');
    if (search) {
        search.value = '';
    }
    app.resetTypeFilters(true);
    app.resetAttributeFilters(true);
    app.searchTermRaw = '';
    app.searchTerm = '';
    app.applyFilters();
}

function openLinkModal(entityId) {
    app.openLinkModal(entityId);
}

function closeLinkModal() {
    app.closeLinkModal();
}

function addLink(event) {
    app.addLink(event);
}

function closeEntityDetailModal() {
    app.closeEntityDetail();
}

// Toggle the filters dropdown (used by the filter button)
function toggleFilterDropdown() {
    const dropdown = document.getElementById('filterDropdown');
    if (!dropdown) return;
    dropdown.classList.toggle('hidden');
}

// Close filter dropdown when clicking outside
document.addEventListener('click', function(e) {
    const btn = document.getElementById('filterButton');
    const dropdown = document.getElementById('filterDropdown');
    if (!dropdown || !btn) return;
    const target = e.target;
    if (dropdown.classList.contains('hidden')) return;
    if (btn.contains(target)) return; // clicked the button
    if (dropdown.contains(target)) return; // clicked inside dropdown
    // otherwise close
    dropdown.classList.add('hidden');
});

// Add-type modal helpers
function openAddTypeModal() {
    app.openAddTypeModal();
}

function closeAddTypeModal() {
    app.closeAddTypeModal();
}

function openInvestigationSettingsModal() {
    app.openInvestigationSettingsModal();
}

function closeInvestigationSettingsModal() {
    app.closeInvestigationSettingsModal();
}

// Initialize app
const app = new InvestigationApp();

function copyInvestigationCode(buttonEl) {
    if (!buttonEl) return;
    const code = buttonEl.dataset.code;
    if (!code) return;

    const setSuccessState = () => {
        const label = buttonEl.querySelector('[data-code-display]');
        const icon = buttonEl.querySelector('i');
        const defaultClasses = ['text-blue-400', 'hover:text-blue-300', 'border-blue-500/40'];
        const successClasses = ['text-emerald-300', 'border-emerald-500/60', 'bg-emerald-500/10'];

        label && (label.textContent = buttonEl.dataset.copiedLabel || 'Copié !');
        buttonEl.classList.remove(...defaultClasses);
        buttonEl.classList.add(...successClasses);
        icon && icon.classList.replace('fa-copy', 'fa-check');

        if (buttonEl._copyTimeout) {
            clearTimeout(buttonEl._copyTimeout);
        }

        buttonEl._copyTimeout = setTimeout(() => {
            label && (label.textContent = buttonEl.dataset.originalLabel || code);
            buttonEl.classList.remove(...successClasses);
            buttonEl.classList.add(...defaultClasses);
            icon && icon.classList.replace('fa-check', 'fa-copy');
        }, 1600);
    };

    const setErrorState = () => {
        app.showNotification('Impossible de copier le code', 'error');
    };

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(code)
            .then(() => {
                setSuccessState();
                app.showNotification('Code copié dans le presse-papiers', 'success');
            })
            .catch(() => setErrorState());
        return;
    }

    const tempInput = document.createElement('input');
    tempInput.value = code;
    tempInput.setAttribute('readonly', '');
    tempInput.style.position = 'absolute';
    tempInput.style.opacity = '0';
    document.body.appendChild(tempInput);
    tempInput.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            setSuccessState();
            app.showNotification('Code copié dans le presse-papiers', 'success');
        } else {
            setErrorState();
        }
    } catch (err) {
        setErrorState();
    }

    document.body.removeChild(tempInput);
}

const investigationCodeButton = document.getElementById('investigationCodeBtn');
if (investigationCodeButton) {
    investigationCodeButton.addEventListener('click', () => copyInvestigationCode(investigationCodeButton));
}

// Handle window resize for network chart
window.addEventListener('resize', () => {
    if (app.networkChart) {
        app.networkChart.resize();
    }
});
</script>
{% endblock %}